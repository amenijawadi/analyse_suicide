name: Render PDFs

on:
  push:
    branches: [main, master]
    paths:
      - 'qmd/**'
      - 'bib.bib'
      - 'apa.csl'

jobs:
  render-pdfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Quarto
      uses: quarto-dev/quarto-actions/setup@v2
    
    # CORRECTION : Installation COMPL√àTE de TinyTeX
    - name: Install TinyTeX properly
      run: |
        echo "üìÑ Installation compl√®te de TinyTeX..."
        
        # 1. Supprimer toute installation pr√©c√©dente
        rm -rf ~/.TinyTeX 2>/dev/null || true
        
        # 2. Installer TinyTeX
        wget -qO- "https://yihui.org/tinytex/install-unx.sh" | sh
        
        # 3. Ajouter au PATH
        TEX_PATH="$HOME/.TinyTeX/bin/x86_64-linux"
        echo "$TEX_PATH" >> $GITHUB_PATH
        
        # 4. Exporter le PATH pour cette √©tape aussi
        export PATH="$TEX_PATH:$PATH"
        
        # 5. Attendre un peu pour que l'installation termine
        sleep 5
        
        # 6. Mettre √† jour et installer les packages n√©cessaires
        tlmgr update --self
        tlmgr option repository https://mirror.ctan.org/systems/texlive/tlnet
        
        # 7. Installer les packages essentiels
        tlmgr install \
          geometry \
          hyperref \
          fancyhdr \
          sectsty \
          microtype \
          booktabs \
          array \
          pdfpages \
          wrapfig \
          float \
          caption \
          subcaption \
          amsmath \
          amsfonts \
          amssymb \
          || echo "‚ö†Ô∏è Certains packages d√©j√† install√©s"
        
        # 8. V√©rifier
        echo "‚úÖ Installation termin√©e"
        which pdflatex
        pdflatex --version | head -2
    
    - name: Render PDFs
      run: |
        echo "üìÑ G√©n√©ration des PDFs..."
        
        # V√©rifier que pdflatex est disponible (sans arr√™ter si √©chec)
        if ! command -v pdflatex &> /dev/null; then
          echo "‚ùå ERREUR: pdflatex non trouv√©!"
          echo "PATH actuel: $PATH"
          echo "Recherche de pdflatex:"
          find ~/.TinyTeX -name pdflatex -type f 2>/dev/null || true
          # Essayer de r√©cup√©rer le PATH
          export PATH="$HOME/.TinyTeX/bin/x86_64-linux:$PATH"
        fi
        
        # V√©rifier √† nouveau
        which pdflatex || { echo "pdflatex toujours introuvable"; exit 1; }
        
        # Rendre les PDFs
        for file in qmd/*.qmd; do
          if [[ -f "$file" ]]; then
            echo "--- Rendu de $(basename "$file") ---"
            quarto render "$file" --to pdf --no-cache || \
              echo "‚ö†Ô∏è √âchec partiel pour $(basename "$file")"
          fi
        done
        
        # Afficher les PDFs g√©n√©r√©s
        echo "üìä PDFs g√©n√©r√©s:"
        ls -la qmd/*.pdf 2>/dev/null || echo "Aucun PDF g√©n√©r√©"
    
    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pdf-outputs
        path: |
          qmd/*.pdf
        retention-days: 7