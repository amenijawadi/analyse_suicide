name: Render PDFs

on:
  push:
    branches: [main, master]
    paths:
      - 'qmd/**'
      - 'bib.bib'
      - 'apa.csl'

jobs:
  render-pdfs:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Quarto
      uses: quarto-dev/quarto-actions/setup@v2
    
    # NE PAS installer TinyTeX ici - l'utiliser depuis le cache
    - name: Check if TinyTeX is available
      run: |
        if command -v pdflatex &> /dev/null; then
          echo "‚úÖ pdflatex est disponible"
          pdflatex --version
        else
          echo "‚ö†Ô∏è pdflatex non trouv√©, installation minimale..."
          # Installation minimale
          wget -qO- "https://yihui.org/tinytex/install-unx.sh" | sh -s -- --admin --no-path
          export PATH="$HOME/.TinyTeX/bin/x86_64-linux:$PATH"
        fi
    
    - name: Render PDFs directly
      run: |
        # Rendre les PDFs
        echo "üìÑ G√©n√©ration des PDFs..."
        
        # V√©rifier que pdflatex est disponible
        which pdflatex || exit 1
        
        for file in qmd/*.qmd; do
          if [[ -f "$file" ]]; then
            echo "Rendu de $file en PDF..."
            quarto render "$file" --to pdf --no-cache || \
            echo "‚ö†Ô∏è √âchec partiel pour $file"
          fi
        done
    
    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pdf-outputs
        path: |
          qmd/*.pdf
        retention-days: 7