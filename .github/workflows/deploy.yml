name: Deploy Quarto Website

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Install Python and Jupyter
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install jupyter nbformat ipykernel jupyter-cache nbclient

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          # NE PAS utiliser use-public-rspm, on va configurer manuellement

      - name: Cache R packages
        uses: actions/cache@v3
        id: r-cache
        with:
          path: |
            /usr/local/lib/R/site-library
            ~/.R/library
          key: ${{ runner.os }}-r4.3-binary-packages-${{ hashFiles('.github/workflows/deploy.yml') }}
          restore-keys: |
            ${{ runner.os }}-r4.3-binary-packages-

      - name: Install system dependencies for binary packages
        run: |
          echo "üì¶ D√©pendances syst√®me pour packages binaires..."
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libcurl4-openssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libpng-dev \
            libharfbuzz-dev \
            libfribidi-dev

      # √âTAPE CRITIQUE : Installation DEPUIS BINAIRES SEULEMENT
      - name: Install R packages FROM BINARIES ONLY (NO SOURCE)
        if: steps.r-cache.outputs.cache-hit != 'true'
        run: |
          echo "‚ö°‚ö°‚ö° Installation EXCLUSIVEMENT depuis binaires ‚ö°‚ö°‚ö°"
          echo "‚ö†Ô∏è  COMPILATION D√âSACTIV√âE - BINAIRES SEULEMENT"
          
          # CR√âATION DU FICHIER DE CONFIGURATION R POUR FORCER LES BINAIRES
          mkdir -p ~/.R
          cat > ~/.Rprofile << 'EOF'
          # ============================================
          # CONFIGURATION GITHUB ACTIONS - BINAIRES ONLY
          # ============================================
          
          # 1. D√âSACTIVER COMPL√àTEMENT LA COMPILATION
          options(
            # FORCER l'utilisation de binaires
            install.packages.compile.from.source = "never",
            # Ne pas v√©rifier les sources
            install.packages.check.source = "no",
            # Ne jamais essayer de compiler
            INSTALL_opts = "--no-compile",
            # Installation parall√®le
            Ncpus = 6
          )
          
          # 2. UTILISER RSPM POUR BINAIRES UBUNTU 22.04
          # RStudio Package Manager avec binaires pr√©-compil√©s
          rspm_url <- "https://packagemanager.rstudio.com/cran/__linux__/jammy/latest"
          
          # V√©rifier que l'URL est accessible
          test_url <- function(url) {
            tryCatch({
              status <- httr::HEAD(url)$status
              return(status == 200)
            }, error = function(e) FALSE)
          }
          
          # Choisir le meilleur d√©p√¥t
          if (test_url(rspm_url)) {
            options(repos = c(RSPM = rspm_url))
            cat("‚úÖ Utilisation de RSPM pour binaires:", rspm_url, "\n")
          } else {
            # Fallback: CRAN avec binaires quand disponibles
            options(repos = c(CRAN = "https://cloud.r-project.org"))
            cat("‚ö†Ô∏è  RSPM non disponible, utilisation de CRAN standard\n")
          }
          
          # 3. FONCTION POUR FORCER L'INSTALLATION BINAIRE
          .First <- function() {
            cat("\n")
            cat("=================================\n")
            cat("MODE BINAIRE FORC√â ACTIV√â\n")
            cat("Compilation source: INTERDITE\n")
            cat("D√©p√¥t:", getOption("repos"), "\n")
            cat("=================================\n")
          }
          EOF
          
          # V√âRIFIER LA CONFIGURATION
          echo "üîç Configuration R charg√©e:"
          Rscript -e "
          cat('\\n=== CONFIGURATION R ===\\n')
          cat('1. D√©p√¥t:', getOption('repos'), '\\n')
          cat('2. Compilation source:', getOption('install.packages.compile.from.source'), '\\n')
          cat('3. Ncpus:', getOption('Ncpus'), '\\n')
          cat('4. INSTALL_opts:', getOption('INSTALL_opts'), '\\n')
          cat('========================\\n\\n')
          "
          
          # LISTE DES PACKAGES (garder minimal pour vitesse)
          R_PACKAGES="'rmarkdown', 'knitr', 'dplyr', 'ggplot2', 'tidyr', 'readxl', 'lubridate', 'car', 'lmtest'"
          
          # M√âTHODE 1: Installation avec pak (le plus rapide, utilise binaires automatiquement)
          echo "üì¶ M√©thode 1: Installation avec 'pak' (recommand√©)..."
          Rscript -e "
          # Installer pak d'abord (tr√®s l√©ger)
          if (!requireNamespace('pak', quietly = TRUE)) {
            install.packages('pak', repos = 'https://r-lib.github.io/p/pak/devel/')
          }
          
          # Utiliser pak pour installer les autres (utilise binaires automatiquement)
          pak::pkg_install(c($R_PACKAGES), ask = FALSE, upgrade = FALSE)
          "
          
          # M√âTHODE 2: Alternative si pak √©choue
          echo "üì¶ M√©thode 2: Installation directe avec v√©rification..."
          Rscript -e "
          packages <- c($R_PACKAGES)
          installed <- rownames(installed.packages())
          missing <- setdiff(packages, installed)
          
          if (length(missing) > 0) {
            cat('Installation des packages manquants:', paste(missing, collapse=', '), '\\n')
            
            # Essayer avec type='binary' d'abord
            for (pkg in missing) {
              cat('\\n‚Üí', pkg, ': ')
              tryCatch({
                # Essayer binaire
                install.packages(pkg, type = 'binary', quiet = TRUE)
                cat('‚úÖ (binaire)')
              }, error = function(e1) {
                # Fallback: installation standard MAIS avec options pour √©viter compilation
                cat('‚ö†Ô∏è  binaire non disponible, installation l√©g√®re... ')
                install.packages(
                  pkg, 
                  INSTALL_opts = c('--no-docs', '--no-test-load', '--no-byte-compile'),
                  quiet = TRUE
                )
                cat('‚úÖ (l√©ger)')
              })
            }
          } else {
            cat('‚úÖ Tous les packages sont d√©j√† install√©s\\n')
          }
          "
          
          # V√âRIFICATION FINALE
          echo "üîç V√©rification finale de l'installation..."
          Rscript -e "
          packages <- c($R_PACKAGES)
          installed <- rownames(installed.packages())
          
          cat('\\n=== R√âSULTATS D\\'INSTALLATION ===\\n')
          for (pkg in packages) {
            if (pkg %in% installed) {
              version <- packageVersion(pkg)
              cat('‚úì', pkg, 'v', as.character(version), '\\n')
            } else {
              cat('‚úó', pkg, 'NON INSTALL√â\\n')
            }
          }
          
          # V√©rifier si compilation a eu lieu
          cat('\\n=== V√âRIFICATION COMPILATION ===\\n')
          lib_path <- .libPaths()[1]
          r_version <- paste(R.version$major, R.version$minor, sep = '.')
          
          # Chercher des fichiers .o ou .so (compil√©s)
          compiled_files <- list.files(
            path = lib_path,
            pattern = '\\.(o|so)$',
            recursive = TRUE,
            full.names = TRUE
          )
          
          if (length(compiled_files) > 0) {
            cat('‚ö†Ô∏è  Fichiers compil√©s d√©tect√©s:', length(compiled_files), '\\n')
            cat('   (peut √™tre normal pour certains packages)\\n')
          } else {
            cat('‚úÖ Aucun fichier compil√© d√©tect√© - binaires purs\\n')
          }
          "
          
          echo "üéØ Installation termin√©e - BINAIRES UNIQUEMENT"

      - name: Disable Jekyll completely
        run: |
          echo "üõë D√©sactivation totale de Jekyll..."
          mkdir -p docs
          echo "NO JEKYLL" > docs/.nojekyll
          rm -rf docs/_site docs/_config.yml 2>/dev/null || true

      - name: Render website
        run: |
          echo "üöÄ Rendu du site..."
          quarto render
          [ -f "docs/index.qmd.html" ] && mv docs/index.qmd.html docs/index.html

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v3