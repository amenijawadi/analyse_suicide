name: Deploy Quarto Site

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2

      - name: Setup Python with cache
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install JUPYTER-CACHE and dependencies
        run: |
          echo "üì¶ Installation de jupyter-cache..."
          
          # Installer jupyter-cache et ses d√©pendances
          python -m pip install jupyter-cache>=0.5.0
          
          # Installer les autres packages Jupyter requis
          python -m pip install nbformat jupyter ipykernel
          
          # V√©rification CRITIQUE
          python -c "
          try:
              import jupyter_cache
              print(f'‚úÖ jupyter-cache: {jupyter_cache.__version__}')
              
              import nbformat
              print(f'‚úÖ nbformat: {nbformat.__version__}')
              
              import jupyter
              print('‚úÖ jupyter: OK')
          except ImportError as e:
              print(f'‚ùå Erreur: {e}')
              exit(1)
          "

      - name: Setup R with cache
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3.2'
          cache: 'packrat'

      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/R
            /usr/local/lib/R/site-library
            ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-packages-${{ hashFiles('**/*.qmd') }}
          restore-keys: |
            ${{ runner.os }}-r-packages-

      - name: Install R packages (INCLUDING jupyter package)
        run: |
          echo "üì¶ Installation des packages R..."
          
          Rscript -e "
            # Packages ABSOLUMENT requis
            required <- c(
              'rmarkdown', 
              'knitr',
              'jupyter',        # <-- IMPORTANT: package R 'jupyter'
              'dplyr', 
              'ggplot2', 
              'readxl', 
              'gplots'
            )
            
            # V√©rifier ce qui est manquant
            installed <- rownames(installed.packages())
            missing <- setdiff(required, installed)
            
            if (length(missing) > 0) {
              cat('Installation de', length(missing), 'packages:', paste(missing, collapse=', '), '\\n')
              
              # Utiliser RSPM pour plus de vitesse
              options(repos = c(CRAN = 'https://packagemanager.rstudio.com/all/__linux__/focal/latest'))
              
              install.packages(
                missing,
                dependencies = TRUE,
                quiet = FALSE,
                Ncpus = 2
              )
            } else {
              cat('‚úÖ Tous les packages R sont d√©j√† install√©s\\n')
            }
            
            # V√©rification sp√©cifique du package jupyter
            if (!requireNamespace('jupyter', quietly = TRUE)) {
              cat('‚ùå Le package R jupyter n\\'est PAS install√©! Installation...\\n')
              install.packages('jupyter', repos = 'https://cloud.r-project.org')
            } else {
              cat('‚úÖ Package R jupyter install√©\\n')
            }
          "

      - name: Install WebR extension
        run: |
          if [ ! -d "_extensions/coatless" ]; then
            quarto add coatless/webr --no-prompt
          fi

      - name: Configure Quarto for jupyter-cache
        run: |
          echo "‚öôÔ∏è Configuration de Quarto pour jupyter-cache..."
          
          # D√©sactiver le cache Jupyter si probl√©matique
          quarto config set execute.cache false
          
          # OU configurer le chemin du cache
          quarto config set jupyter.cache-path /tmp/quarto-jupyter-cache
          
          # V√©rifier la configuration
          quarto config list

      - name: Render WITHOUT Jupyter cache (solution simple)
        run: |
          echo "üöÄ Rendu SANS cache Jupyter..."
          
          rm -rf docs/
          
          # Option 1: D√©sactiver compl√®tement le cache Jupyter
          quarto render --no-cache --to html
          
          # Option 2: Forcer R seulement (si vous n'avez pas besoin de Python)
          # quarto render --execute-engine r --to html
          
          # G√©rer index.html
          [ -f "docs/index.qmd.html" ] && mv docs/index.qmd.html docs/index.html
          [ ! -f "docs/index.html" ] && echo '<html><meta http-equiv="refresh" content="0;url=qmd/"></html>' > docs/index.html
          
          touch docs/.nojekyll

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v3